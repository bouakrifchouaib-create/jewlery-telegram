import os
import requests
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

print("ü§ñ Starting Jewelry Bot...")

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
HF_TOKEN = os.getenv("HF_TOKEN")

class JewelryBot:
    def _init_(self):
        self.application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
        self.setup_handlers()
    
    def setup_handlers(self):
        self.application.add_handler(CommandHandler("start", self.start))
        self.application.add_handler(MessageHandler(filters.PHOTO, self.handle_photo))
        self.application.add_handler(MessageHandler(filters.TEXT, self.handle_text))
    
    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        await update.message.reply_text(
            "Welcome to Jewelry Marketing Bot!\n\n"
            "Send me a product photo and I'll create:\n"
            "‚Ä¢ Marketing description\n‚Ä¢ Hashtags\n‚Ä¢ Tips\n\n"
            "Send a product photo now!"
        )
    
    async def handle_photo(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        await update.message.reply_text("üîÑ Analyzing your image...")
        
        try:
            # Download photo
            photo_file = await update.message.photo[-1].get_file()
            image_data = await photo_file.download_as_bytearray()
            
            # Analyze image
            analysis = await self.analyze_image(image_data)
            await update.message.reply_text(f"üìã {analysis}")
            
            # Create marketing content
            await self.create_marketing_content(update.message.chat_id, analysis)
            
        except Exception as e:
            await update.message.reply_text(f"‚ö† Error: {str(e)}")
    
    async def analyze_image(self, image_data):
        API_URL = "https://api-inference.huggingface.co/models/Salesforce/blip-image-captioning-base"
        headers = {"Authorization": f"Bearer {HF_TOKEN}"}
        
        response = requests.post(API_URL, headers=headers, data=bytes(image_data))
        
        if response.status_code == 200:
            result = response.json()
            return f"Product: {result.get('generated_text', 'Elegant jewelry product')}"
        return "Luxury jewelry product - high quality"
    
    async def create_marketing_content(self, chat_id, description):
        content = f"""
üíé *Marketing Content Ready*

üìù *Professional Description:*
"Discover the beauty of {description} ‚ú®
Elegant design and exceptional quality"

üè∑ *Hashtags:*
#Jewelry #Accessories #Gold #Diamond #Fashion
#Luxury #Gifts #Algeria

üéØ *Marketing Tips:*
‚Ä¢ Use natural lighting
‚Ä¢ Shoot from multiple angles
‚Ä¢ Show size comparison
‚Ä¢ Highlight quality details
"""
        await self.application.bot.send_message(chat_id, content)
    
    async def handle_text(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        if update.message.text != "/start":
            await update.message.reply_text("üì∏ Send a product photo for marketing content!")
    
    def run(self):
        print("‚úÖ Bot is running on Render!")
        self.application.run_polling()

if _name_ == "_main_":
    bot = JewelryBot()
    bot.run()
