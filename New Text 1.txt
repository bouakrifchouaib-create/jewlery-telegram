import os
import requests
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
HF_TOKEN = os.getenv("HF_TOKEN")

class JewelryBot:
    def _init_(self):
        self.application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
        self.setup_handlers()
    
    def setup_handlers(self):
        self.application.add_handler(CommandHandler("start", self.start))
        self.application.add_handler(MessageHandler(filters.PHOTO, self.handle_photo))
        self.application.add_handler(MessageHandler(filters.TEXT, self.handle_text))
    
    async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        await update.message.reply_text(
            "ğŸ‰ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª!\n\n"
            "ğŸ“¸ Ø£Ø±Ø³Ù„ Ù„ÙŠ ØµÙˆØ±Ø© Ø£ÙŠ Ù…Ù†ØªØ¬ (Ø®Ø§ØªÙ…ØŒ Ø¹Ù‚Ø¯ØŒ Ø¥ÙƒØ³Ø³ÙˆØ§Ø±) ÙˆØ³Ø£ØµÙ†Ø¹ Ù„Ùƒ:\n"
            "â€¢ ÙˆØµÙ ØªØ³ÙˆÙŠÙ‚ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ\nâ€¢ Ù‡Ø§Ø´ØªØ§Ù‚Ø§Øª Ø¬Ø°Ø§Ø¨Ø©\nâ€¢ Ù†ØµØ§Ø¦Ø­ Ù„Ù„ØªØµÙˆÙŠØ±\n\n"
            "ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† Ø¨Ø¥Ø±Ø³Ø§Ù„ ØµÙˆØ±Ø© Ù…Ù†ØªØ¬Ùƒ!"
        )
    
    async def handle_photo(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        await update.message.reply_text("ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ ØµÙˆØ±ØªÙƒ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ ØªØ³ÙˆÙŠÙ‚ÙŠ...")
        
        try:
            # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
            photo_file = await update.message.photo[-1].get_file()
            image_data = await photo_file.download_as_bytearray()
            
            # ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
            analysis = await self.analyze_image(image_data)
            await update.message.reply_text(f"ğŸ“‹ {analysis}")
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ ØªØ³ÙˆÙŠÙ‚ÙŠ
            await self.create_marketing_content(update.message.chat_id, analysis)
            
        except Exception as e:
            await update.message.reply_text(f"âš  Ø®Ø·Ø£: {str(e)}")
    
    async def analyze_image(self, image_data):
        API_URL = "https://api-inference.huggingface.co/models/Salesforce/blip-image-captioning-base"
        headers = {"Authorization": f"Bearer {HF_TOKEN}"}
        
        response = requests.post(API_URL, headers=headers, data=bytes(image_data))
        
        if response.status_code == 200:
            result = response.json()
            return f"ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬: {result.get('generated_text', 'Ù…Ù†ØªØ¬ Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª Ø£Ù†ÙŠÙ‚')}"
        return "Ù…Ù†ØªØ¬ Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª ÙØ§Ø®Ø± - Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©"
    
    async def create_marketing_content(self, chat_id, description):
        content = f"""
ğŸ’ *Ù…Ø­ØªÙˆÙ‰ ØªØ³ÙˆÙŠÙ‚ÙŠ Ø¬Ø§Ù‡Ø²*

ğŸ“ *Ø§Ù„ÙˆØµÙ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ:*
"Ø§ÙƒØªØ´Ù Ø¬Ù…Ø§Ù„ {description} âœ¨
ØªØµÙ…ÙŠÙ… Ø£Ù†ÙŠÙ‚ ÙˆØ¬ÙˆØ¯Ø© Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ© ØªÙ†Ø§Ø³Ø¨ Ø°ÙˆÙ‚Ùƒ Ø§Ù„Ø±ÙÙŠØ¹"

ğŸ· *Ø§Ù„Ù‡Ø§Ø´ØªØ§Ù‚Ø§Øª:*
#Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª #Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª #Ø°Ù‡Ø¨ #Ù…Ø§Ø³ #Ø£Ù†Ø§Ù‚Ø©
#Ù…ÙˆØ¶Ø© #ØªØ³ÙˆÙ‚_Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ #Ø¬Ø²Ø§Ø¦Ø± #Ù‡Ø¯Ø§ÙŠØ§

ğŸ¯ *Ù†ØµØ§Ø¦Ø­ ØªØ³ÙˆÙŠÙ‚ÙŠØ©:*
â€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø¥Ø¶Ø§Ø¡Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©
â€¢ ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø²ÙˆØ§ÙŠØ§ Ù…ØªØ¹Ø¯Ø¯Ø©  
â€¢ Ø£Ø¶Ù Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ø§Ù„Ø£Ø­Ø¬Ø§Ù…
â€¢ highlight Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„ØªÙØ§ØµÙŠÙ„
"""
        await self.application.bot.send_message(chat_id, content)
    
    async def handle_text(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        if update.message.text != "/start":
            await update.message.reply_text("ğŸ“¸ Ø£Ø±Ø³Ù„ ØµÙˆØ±Ø© Ù…Ù†ØªØ¬Ùƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ ØªØ³ÙˆÙŠÙ‚ÙŠ Ù…Ø®ØµØµ!")
    
    def run(self):
        print("ğŸ¤– Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„ Ø¹Ù„Ù‰ Render!")
        self.application.run_polling()

if _name_ == "_main_":
    bot = JewelryBot()
    bot.run()